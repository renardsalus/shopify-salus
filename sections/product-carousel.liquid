<div class="carousel-background-wrapper">
  <div class="carousel-section mx-auto">
    <div class="carousel-header">
      <div class="header-left">
        {%- if section.settings.affirm_product != blank -%}
          {%- assign affirm_product = all_products[section.settings.affirm_product] -%}
          {% render 'affirm-messaging', product: affirm_product %}
        {%- endif -%}

        <h2>{{ section.settings.title }}</h2>
      </div>

      <div class="header-right">
        {%- assign button_collection = section.settings.button_collection -%}
        {%- if button_collection != blank and section.settings['button-label'] != blank -%}
          <a href="{{ button_collection.url }}" class="explore-all-btn cta-btn">
            {{ section.settings['button-label'] }}
            <span class="cta-arrow">➜</span>
          </a>
        {%- else -%}
          <a href="{{ routes.collections_url }}" class="explore-all-btn cta-btn">
            Explore All Saunas <span class="cta-arrow">➜</span>
          </a>
        {%- endif -%}
      </div>
    </div>
    <div class="carousel-container">
      <div class="carousel-track">
        {% # This variable holds the collection for the PRODUCTS to display. # %}
        {%- assign products_to_display_collection = section.settings.products_to_display_collection -%}

        {% # Loop through the products from the DISPLAY collection. # %}
        {%- for product in products_to_display_collection.products -%}
          <div class="product-card">
            <div class="product-image-wrapper">
              <a href="{{ product.url }}">
                <img
                  src="{{ product.featured_image | image_url: width: 400 }}"
                  alt="{{ product.featured_image.alt | escape }}"
                  width="400"
                  height="{{ 400 | divided_by: product.featured_image.aspect_ratio | round }}"
                  loading="lazy"
                >
              </a>

              {%- if product.tags contains 'New Release' -%}
                <span class="badge release-badge">✦ New Release</span>
              {%- endif -%}
            </div>
            <div class="product-info">
              <div class="shipping-tag">
                {% if product.metafields.custom.product_tag_free_shipping != blank %}
                  <div class="card-shipping-tag">
                    <span
                      ><img src="{{ 'shipping-icon.svg' | asset_url }}" alt="shipping icon indicator">
                      {{- product.metafields.custom.product_tag_free_shipping -}}
                    </span>
                  </div>
                {% endif %}
              </div>
              <a href="{{ product.url }}" class="product-title">{{ product.title }}</a>
              {% comment %} {%- assign rating_metafield = product.metafields.reviews.rating.value -%} {% endcomment %}
              {% comment %} {%- assign rating_value_as_number = rating_metafield.rating | plus: 0 -%} {% endcomment %}
              {% comment %}
                {%- if rating_metafield and rating_value_as_number > 0 -%}
                  <div class="star-rating">
                    <span class="stars" style="--rating: {{ rating_metafield.rating | default: 0 }};"></span>
                    <span>({{ product.metafields.reviews.rating_count }})</span>
                  </div>
                {%- endif -%}
              {% endcomment %}
              {%- if settings.card_show_rating -%}
                <div class="product_ratings">
                  <div class="jdgm-widget jdgm-preview-badge">
                    <span class="rating-counter">{{ product.metafields.reviews.rating.value }}</span>
                    {{ product.metafields.judgeme.badge }}
                  </div>
                </div>
              {% endif %}
              <div class="price">
                <span class="current-price">{{ product.price | money }}</span>
                {%- if product.compare_at_price > product.price -%}
                  <span class="compare-at-price">{{ product.compare_at_price | money }}</span>
                {%- endif -%}
              </div>
              <a href="{{ product.url }}" class="learn-more-btn">Learn More</a>
            </div>
          </div>
        {%- else -%}
          <div class="product-card--empty">
            <p>No products found. Please select a collection in the theme editor settings for this section.</p>
          </div>
        {%- endfor -%}
      </div>
      <button class="carousel-arrow arrow-left">❮</button>
      <button class="carousel-arrow arrow-right">❯</button>
    </div>
  </div>
</div>

{% comment %}
  Shopify will automatically load these files on any page where this section is used.
  This is more efficient than loading them on every page in theme.liquid.
{% endcomment %}
{{ 'product-carousel.css' | asset_url | stylesheet_tag }}
<script src="{{ 'product-carousel.js' | asset_url }}" defer="defer"></script>

{% comment %}
  This is the schema. It defines the settings that appear in the
  Shopify Theme Customizer for this specific section.
{% endcomment %}
{% schema %}
{
  "name": "Product Carousel",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Heading",
      "default": "Explore our best-in-class infrared saunas"
    },
    {
      "type": "header",
      "content": "Button Settings"
    },
    {
      "type": "text",
      "id": "button-label",
      "label": "Button Label",
      "default": "Explore All Saunas"
    },
    {
      "type": "collection",
      "id": "button_collection",
      "label": "Collection for Button Link",
      "info": "The 'Explore All' button will link to this main collection."
    },
    {
      "type": "header",
      "content": "Products to Display"
    },
    {
      "type": "product",
      "id": "affirm_product",
      "label": "Affirm Product (optional)",
      "info": "Select a product to use for Affirm promotional messaging above the heading."
    },
    {
      "type": "collection",
      "id": "products_to_display_collection",
      "label": "Collection to Display Products From",
      "info": "Create a manual collection with 7 products to show in the carousel."
    }
  ],
  "presets": [
    {
      "name": "Product Carousel"
    }
  ]
}
{% endschema %}
