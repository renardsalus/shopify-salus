{%- comment -%}theme-check-disable LiquidTag{%- endcomment -%}
{%- comment -%}
  Parameters:
  - product {Object} - Product object.
  - collection {Object} - Collection object (optional).
  - image_ratio {Number} - Aspect ratio for the image(s).
  - disable_quickbuy {Boolean} - Force disables quickbuy (even if enabled in settings)

  Usage:
  {% render 'product-card', product: product %}
{%- endcomment -%}

{%- liquid
  if collection and settings.card_url_within_coll and product.collections contains collection
    assign product_url = product.url | within: collection
  else
    assign product_url = product.url
  endif

  if product_url contains '?'
    assign product_url = product_url | split: '?' | first
  endif

  assign current_variant = product.selected_or_first_available_variant
  assign product_images = product.media | where: 'media_type', 'image'

  if settings.card_show_hover_image and product_images.size > 1
    assign show_hover_image = true

    if product_images.size >= product.featured_media.position
      assign hover_image = product_images[product.featured_media.position]
    else
      assign hover_image = product_images[0]
    endif
  else
    assign show_hover_image = false
  endif

  if image_ratio == null
    if settings.prod_card_image_ratio == 'shortest' or settings.prod_card_image_ratio == 'tallest'
      assign image_ratio = 1
    else
      assign image_ratio = settings.prod_card_image_ratio
    endif
  elsif image_ratio == 0 or image_ratio == 99
    assign image_ratio = 1
  endif

  if section.settings.card_size == 'small'
    assign swatch_limit = 4
  else
    assign swatch_limit = 7
  endif

  if product.featured_media
    if section.settings.card_size == 'small'
      capture sizes
        render 'sizes-attribute', grid: true, min: 2, sm: 3, md: 4, xl: 5
      endcapture
    elsif section.settings.card_size == 'large'
      capture sizes
        render 'sizes-attribute', grid: true, min: 1, sm: 2, xl: 3
      endcapture
    else
      capture sizes
        render 'sizes-attribute', grid: true, min: 1, sm: 3, md: 4
      endcapture
    endif

    if settings.prod_card_image_fit == 'contain'
      assign class = 'img-fit img-fit--contain card__main-image'
    else
      assign class = 'img-fit card__main-image ' | append: settings.prod_card_image_align
    endif

    if product.featured_media.preview_image == product_images.last
      assign show_hover_image = false
    endif
  endif

  assign image_quality = 1
  if product.featured_media.preview_image.aspect_ratio > 1 and settings.prod_card_image_ratio != '1.77' and settings.prod_card_image_fit == 'cover'
    assign image_quality = 2
  endif

  assign product_not_for_sale = false
  if product.template_suffix contains 'coming-soon' or product.template_suffix contains 'countdown'
    assign product_not_for_sale = true
  endif

  assign card_class = ''
  if product.template_suffix contains 'preorder'
    assign card_class = ' card--product-preorder'
  elsif product.template_suffix contains 'coming-soon'
    assign card_class = ' card--product-coming-soon'
  elsif product.template_suffix contains 'countdown'
    assign card_class = ' card--product-countdown'
  endif
-%}

{%- if product and product != empty -%}
  <product-card class="manual-video-card card card--product{{ card_class }} h-full{% if settings.card_contain %} card--product-contained{% endif %}{% unless settings.show_dividers %} card--no-lines{% endunless %}{% if show_compare %} card--product-compare{% endif %} relative flex">
    <div class="card__media{% if show_hover_image %} has-hover-image{% endif %}{% if settings.blend_product_images %} image-blend{% endif %} relative">
      {% if show_category_tag and product.metafields.custom.product_tag != blank %}
        <span class="product-category-badge">{{ product.metafields.custom.product_tag }}</span>
      {% endif %}
      <a
        href="{% if card_type == 'manual' %}{{ product.metafields.custom.owners_manual }}{% else %}{{- product.url | append:'#product-video' -}}{% endif %}"
        aria-label="{{ product.title | escape }}"
        class="media block relative{% if settings.blend_product_images %} image-blend{% endif %} js-prod-link"
        style="padding-top: {{ 1 | divided_by: image_ratio | times: 100 }}%;"
        tabindex="-1"
      >
        {%- if product.featured_media -%}
          {% assign media_ext = product.featured_media
            | img_url
            | split: '.'
            | last
            | split: '?'
            | first
            | append: '_type'
          %}
          {% assign class = class | append: media_ext %}
          {%- capture attributes %}data-media-id="{{ product.featured_media.id }}"{% endcapture -%}
          {% render 'image',
            image: product.featured_media.preview_image,
            widths: '320, 460, 600, 700, 800, 900, 1200',
            src_width: 460,
            src_placeholder: true,
            sizes: sizes,
            class: class,
            attributes: attributes,
            disable_focal_point: true,
            quality: image_quality
          %}

          {%- if settings.card_colors_style == 'swatches' or settings.card_colors_style == 'variant-images' -%}
            {%- assign variant_media = product.variants | map: 'featured_media' -%}
            {%- for media in variant_media -%}
              {%- unless media == product.featured_media -%}
                {%- capture attributes %}data-media-id="{{ media.id }}" hidden{% endcapture -%}
                {% render 'image',
                  image: media,
                  widths: '320, 460, 600, 700, 800, 900, 1200',
                  src_width: 460,
                  sizes: sizes,
                  class: class,
                  attributes: attributes,
                  disable_focal_point: true,
                  quality: image_quality
                %}
              {%- endunless -%}
            {%- endfor -%}
          {%- endif -%}

          {%- if show_hover_image -%}
            {%- assign class = class | replace: 'card__main-image', 'card__hover-image' -%}
            {% render 'image',
              image: hover_image,
              widths: '320, 460, 600, 700, 800, 900, 1200',
              src_width: 460,
              src_placeholder: true,
              sizes: sizes,
              class: class,
              disable_focal_point: true,
              quality: image_quality
            %}
          {%- endif -%}
        {%- else -%}
          {{ 'image' | placeholder_svg_tag: 'media__placeholder img-fit' }}
        {%- endif -%}
      </a>
    </div>

    <div class="card__info-container flex flex-col flex-auto relative">
      <div class="card__info w-full">
        <div class="card__info-inner{% if settings.card_price_bottom %} flex flex-col h-full{% else %} inline-block{% endif %} w-full">
          <div class="product-title-wrapper">
            <p class="card__title font-bold{% if settings.show_dividers %} mb-1{% else %} mt-1 mb-0{% endif %}">
              <a href="{{ product.metafields.custom.owners_manual }}" class="card-link text-current js-prod-link">
                {{- product.title | escape -}}
              </a>
            </p>
          </div>
        </div>
        {% if card_type == 'manual' %}
          <div class="download-manual-btn">
            <a href="{{ product.metafields.custom.owners_manual }}" class="btn btn--primary"
              >Download manual <img src="{{ 'icon-download.svg' | asset_url}}"
            ></a>
          </div>
        {% else %}
          <div class="assembly-video-btn">
            <a href="{{ product.url }}#product-video" class="btn btn--primary"
              ><img src="{{ 'assembly-video-play.svg' | asset_url}}"> Watch assembly video</a
            >
          </div>
        {% endif %}
      </div>
    </div>
  </product-card>
{%- else -%}
  <div class="card">
    <div class="card__media">
      <div class="media relative" style="padding-top: {{ 1 | divided_by: image_ratio | times: 100 }}%;">
        {%- capture placeholder_name -%}product-{{ 'now' | date: '%N' | modulo: 6 | plus: 1 }}{%- endcapture -%}
        {{ placeholder_name | placeholder_svg_tag: 'media__placeholder img-fit' }}
      </div>
    </div>
    <div class="card__info">
      <p class="card__title font-bold">{{ 'onboarding.product.title' | t }}</p>
    </div>
  </div>
{%- endif -%}
